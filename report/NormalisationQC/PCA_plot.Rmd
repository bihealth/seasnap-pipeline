## Principal component analysis

The principal component analysis plot shown below was generated using the most varying `r config$report$snippet_parameters$Normalisation_QC$n_most_varying` genes across all samples.
The expression values are obtained by the "`r config$normalization$normalized_expression`" method, where the normalisation doesn't take into account the experimental design.

In presence of strong biological signal, the samples should cluster with the biological condition.
When samples are clustered according to other effects (for example patient, or technical batch), great care must be used when interpreting the results, as the other effects will considerably reduce the ability to extract meaningful biological information.

```{r normalisationQCPCA2_calc}
intgroups <- config$report$snippet_parameters$Normalisation_QC$annotation_columns
mtx <- t(assay(RLD_BLIND))
vars <- apply(mtx, 2, var)
sel <- vars > 1e-26
pca <- prcomp(mtx[ , sel], scale.=TRUE)
numplots <- floor(ncol(pca$x)/2)
numplots <- min(numplots, 6)

nrow <- ceiling(numplots/2)
ncol <- 2
```

```{r normalisationQCPCA2,fig.width=6 * ncol,fig.height=6 * nrow}
group <- NULL
if(length(intgroups) > 0) {
  group <- factor(colData(RLD_BLIND)[[intgroups[1]]])
}

shape <- NULL
if(length(intgroups) > 1) {
  shape <- factor(colData(RLD_BLIND)[[intgroups[2]]])
}

#tmp <- plotPCA(RLD_BLIND, intgroup=intgroups, returnData=TRUE)
#percentVar <- 100 * attr(tmp, "percentVar")
library(RColorBrewer)
pal <- brewer.pal(12, "Set1")
if(is.null(group)) {
  col <- "grey"
} else {
  col <- pal[ group ]
}

if(is.null(shape)) {
  pch <- 19
} else {
  pch <- c(15, 17, 19, 1:6)[shape]
}


par(bty="n")
par(pch=19)
par(mfrow=c(nrow, ncol))
for(i in 1:numplots) {
  plot(pca$x[,i * 2 - 1], pca$x[, i * 2], col=col, pch=pch, xlab=paste0("PC", i * 2 - 1), ylab=paste0("PC2", i * 2))
  if(!is.null(group)) {
    legend("bottomleft", levels(group), col=pal, pch=pch[1], bty="n")
  }
  if(!is.null(shape)) {
    legend("bottomright", levels(shape), col="grey", pch=c(15, 17, 19, 1:6), bty="n")
  }
}

fn <- file.path(PLOTS_DIR, "PCA_2.pdf")
dev.copy2pdf(file=fn)
```

[Download plot](`r fn`)

