#REQUIRE {{tmod-rds-{{ENTRY_ID}}}}

```{r tmod_conf_{{ENTRY_ID}}}
#----- import packages
require(tidyverse)
require(pander)
require(DT)
require(purrr)
require(dplyr)

# ---- get wildcards
c_id       <- "{{ENTRY_ID}}"
c_name     <- "{{ENTRY_NAME}}"
tmod_res.f <- "{{tmod-rds-{{ENTRY_ID}}}}"

# load tmod functions
r.path <- "{{R_COMMON}}"
script_f <- file.path(r.path, "..", "..", "external_scripts", "tmod_functions.R")
source(script_f)

snip.par     <- config$report$snippet_parameters$tmod_contrast
res_auc_thr  <- snip.par$res_auc_thr
res_pval_thr <- snip.par$res_pval_thr
if(is.null(res_auc_thr)) res_auc_thr <- .65
if(is.null(res_pval_thr)) res_pval_thr <- .01

## No wildcards beyond this point except in chunk names
```

```{r tmod_contrast_{{ENTRY_ID}}}
# load results table
message(sprintf("tmod contrast %s, reading file %s", c_id, tmod_res.f))
tmod_res <- readRDS(tmod_res.f)
```


### `tmod` enrichment analysis for `r c_name`


**Table.** Summary of the results for contrast `r c_name` shows number of
significant gene sets at various significance levels and for AUC > 0.65.

```{r, results="asis"}
pval.thr <- c(.01, .001, 1e-4, 1e-6)

tmp <- purrr::imap_dfr(tmod_res, ~ {
  .r <- .x
  .rn <- .y
  ret <- t(sapply(.r, function(.s) {
    sapply(pval.thr, function(.pt) {
      sum(.s$adj.P.Val < .pt & .s$AUC > 0.65, na.rm=TRUE)
    })
  }))
  data.frame(DB=.y, ret)
})

colnames(tmp) <- c("DB", pval.thr)
pandoc.table(tmp, row.names=FALSE, split.tables=Inf)
```


**Table.** Results of the tmod enrichment analysis for contrast `r c_name`.
Only significantly enriched gene sets are shown (FDR < `r res_pval_thr`, 
AUC > `r res_auc_thr`). **AUC**, area under curve; **p.value**, p-value
from enrichment test; **FDR**, p-value corrected for multiple testing with
Benjamini-Hochberg method.

```{r, tmod_contrast_result_list{{ENTRY_ID}}, results="asis"}
## each datatable must be knitted in a separate chunk, otherwise it doesn't
## work
resU  <- unlist(tmod_res, recursive=FALSE)
mytab <- data.frame(ID=1:3, foo=letters[1:3])

template <- "
\n```{r}
datatable(mytab, extensions=c('Buttons','FixedColumns'), rownames=FALSE, escape=FALSE,
        options = list(scrollX=TRUE, fixedColumns=list(leftColumns=1), dom='Bfrtip', buttons=c('excel', 'csv'))) %>%
        formatSignif('p.value', 2) %>%
        formatSignif('FDR', 2) %>%
        formatSignif('AUC', 2)

\n```

"

cat("\n##### {- .tabset}\n")

for(db in names(resU)) {
  mytab <- tmod_filter_format_res(resU[[db]], pval.thr=res_pval_thr, AUC.thr=res_auc_thr)
  cat(sprintf("\n###### %s {-}\n", db))
  if(!is.null(resU[[db]]) && nrow(mytab) > 0) {
    out <- knitr::knit_child(text=template, quiet=TRUE)
    cat(out)
  } else {
    cat("**No results at the specified thresholds**\n")
  }

}
```










